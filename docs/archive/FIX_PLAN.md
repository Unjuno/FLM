# プロジェクト修正計画

## 概要
専門家評価に基づくコード品質向上のための修正計画

## 修正タスク一覧

### 🔴 高優先度（即座に対応が必要）

#### 1. Rustコードの安全性向上
**問題点:**
- `unwrap()`, `expect()`, `panic!` の多用（44箇所）
- エラーハンドリングが不十分

**修正内容:**
- `unwrap()` を適切な `Result` 処理に置き換え
- `panic!` を本当に必要な場合のみに限定
- エラーメッセージの詳細化

**対象ファイル:**
- `src-tauri/src/lib.rs` - グローバルランタイム初期化の改善
- `src-tauri/src/engines/ollama.rs` - エラーハンドリングの改善
- `src-tauri/src/commands/api.rs` - データベース操作のエラーハンドリング改善
- `src-tauri/src/utils/remote_sync.rs` - `unwrap()` の削減
- `src-tauri/src/database/encryption.rs` - `expect()` の削減

#### 2. 非同期処理の再設計
**問題点:**
- グローバルTokioランタイムの使用
- スレッド内で新しいランタイムを作成

**修正内容:**
- グローバルランタイムの削除
- Tauriの非同期コマンドを活用
- `tokio::task::spawn_blocking` の適切な使用

**対象ファイル:**
- `src-tauri/src/lib.rs` - グローバルランタイムの削除
- `src-tauri/src/commands/api.rs` - 非同期処理の改善

#### 3. データベース操作の改善
**問題点:**
- エラーメッセージが不十分
- トランザクション管理が不明確

**修正内容:**
- エラーメッセージに詳細情報を含める
- トランザクション管理の明確化
- 接続プールの検討（将来の改善）

**対象ファイル:**
- `src-tauri/src/commands/api.rs` - エラーメッセージの改善
- `src-tauri/src/database/repository.rs` - トランザクション管理の追加

#### 4. エラー型の構造化
**問題点:**
- 文字列マッチングによるエラー判定
- エラー型の階層化が不十分

**修正内容:**
- 構造化されたエラー型の導入
- エラー種別を型で表現
- `thiserror` クレートの検討

**対象ファイル:**
- `src-tauri/src/utils/error.rs` - エラー型の拡張
- `src-tauri/src/engines/ollama.rs` - エラー判定の改善

### 🟡 中優先度（近いうちに対応）

#### 5. フロントエンド初期化処理の改善
**問題点:**
- 固定の `setTimeout(500)` による待機
- コメントが多く実装が不明確

**修正内容:**
- 適切な初期化完了待機処理の実装
- 不要なコメントの削除

**対象ファイル:**
- `src/App.tsx` - 初期化処理の改善

#### 6. ログシステムの改善
**問題点:**
- `eprintln!` の直接使用
- 構造化ログの未導入

**修正内容:**
- ログクレート（`tracing` または `log`）の適切な使用
- 構造化ログの導入検討

**対象ファイル:**
- `src-tauri/src/lib.rs` - ログマクロの改善
- 全Rustファイル - ログ出力の統一

## 実装順序

1. ✅ エラー型の拡張（基盤となるため最初に実施）
2. ✅ データベース操作のエラーハンドリング改善
3. 🔄 Rustコードの安全性向上（unwrap/expect/panicの削減） - 進行中
4. ⏳ 非同期処理の再設計 - 未着手
5. ✅ フロントエンド初期化処理の改善
6. ⏳ ログシステムの改善 - 未着手

## 実装済みの修正

### 1. エラー型の拡張 ✅
- `thiserror`クレートを追加
- `AppError`に`ConnectionError`型を追加
- `is_connection_error()`メソッドを追加
- `reqwest::Error`からの変換を追加
- エラーに`source`フィールドを追加（デバッグ情報用）

### 2. データベース操作のエラーハンドリング改善 ✅
- エラーメッセージに詳細情報を含めるように改善
- `map_err`でエラー詳細を保持
- すべてのデータベース操作でエラーメッセージを改善

### 3. Ollamaエンジンのエラー判定改善 ✅
- 文字列マッチングによるエラー判定を削除
- `is_connection_error()`メソッドを使用するように変更

### 4. フロントエンド初期化処理の改善 ✅
- 固定の`setTimeout(500)`を削除
- `Promise.race`を使用したタイムアウト処理を実装
- エラーハンドリングを改善

### 5. グローバルランタイムのpanic改善 ✅
- panicメッセージに詳細情報を追加
- エラーログを追加

## 注意事項

- 既存の機能を壊さないように注意深く修正
- 各修正後にテストを実行
- 段階的に修正を進め、一度に多くの変更を加えない

