# プライバシー監査レポート 最終版（第4回監査）

**プロジェクト名**: FLM (Local LLM API Manager)  
**監査日**: 2025年1月（第4回監査）  
**バージョン**: 1.0.0  
**監査者**: AI アシスタント  
**監査範囲**: コードベース全体の包括的分析（パフォーマンスメトリクス、キャッシュ、アラート、証明書生成を含む）

---

## エグゼクティブサマリー

本レポートは、FLMアプリケーションのプライバシーに関する第4回目の包括的な監査結果をまとめたものです。前回の監査を基に、パフォーマンスメトリクス、キャッシュ機能、アラート機能、証明書生成などの詳細な実装分析を行い、新たに発見された問題点と改善提案を提示します。

### 総合評価

**プライバシー保護レベル**: ⚠️ **中程度（前回と同様）**

### 新たに発見された重要な問題

1. **パフォーマンスメトリクスにシステム情報が含まれる**: CPU使用率、メモリ使用率が収集される
2. **IPアドレスの使用**: レート制限と証明書生成でIPアドレスが使用される
3. **キャッシュにAPI設定が保存される**: メモリ内にAPI設定が一時保存される
4. **証明書にローカルIPアドレスが含まれる**: 証明書生成時にローカルIPアドレスが含まれる可能性

---

## 1. パフォーマンスメトリクスの収集

### 1.1 収集されるメトリクス

**ファイル**: `src/backend/auth/server.ts`

#### 収集内容
1. **平均レスポンス時間** (`avg_response_time`)
   - 評価: ✅ 問題なし（技術的な情報のみ）

2. **リクエスト数** (`request_count`)
   - 評価: ✅ 問題なし（技術的な情報のみ）

3. **エラー率** (`error_rate`)
   - 評価: ✅ 問題なし（技術的な情報のみ）

4. **CPU使用率** (`cpu_usage`)
   - 評価: ⚠️ **改善推奨**
   - **問題点**:
     - システムリソース情報が収集される
     - 個人を特定できる情報ではないが、システム情報が含まれる
   - **推奨事項**:
     - プライバシーポリシーに明記
     - メトリクス収集のオプトアウト機能

5. **メモリ使用率** (`memory_usage`)
   - 評価: ⚠️ **改善推奨**
   - **問題点**: CPU使用率と同様
   - **推奨事項**: CPU使用率と同様

### 1.2 メトリクスの保存

#### 保存場所
- データベース（`performance_metrics`テーブル）
- メモリ内バッファ（一時保存、1分間隔でフラッシュ）

#### 評価: ✅ **良好**
- ローカルデータベースにのみ保存
- 外部送信は行われない
- バッファリングにより効率的に処理

---

## 2. IPアドレスの使用

### 2.1 レート制限でのIPアドレス使用

**ファイル**: `src/backend/auth/rate-limit.ts`, `src/backend/auth/rate-limit-redis.ts`

#### 使用目的
- レート制限の識別子として使用
- フォーマット: `${apiId}:ip:${ip}`

#### 評価: ⚠️ **改善推奨**
- **問題点**:
  - IPアドレスが識別子として使用される
  - ログに含まれる可能性
- **推奨事項**:
  - IPアドレスのハッシュ化を検討
  - ログにIPアドレスを含めない設定

### 2.2 証明書生成でのIPアドレス使用

**ファイル**: `src/backend/auth/certificate-generator.ts`

#### 使用目的
- 証明書のSubject Alternative Name (SAN)に含まれる
- ローカルIPアドレス（192.168.x.x、10.x.x.x、172.16-31.x.x）が含まれる可能性

#### 評価: ✅ **問題なし**
- ローカルIPアドレスのみ
- 証明書はローカルに保存される
- 外部送信は行われない

---

## 3. キャッシュ機能のプライバシー

### 3.1 メモリ内キャッシュ

**ファイル**: `src-tauri/src/utils/cache.rs`

#### キャッシュ内容
1. **モデル一覧キャッシュ** (`ModelListCache`)
   - TTL: 60秒
   - 評価: ✅ 問題なし（技術的な情報のみ）

2. **API設定キャッシュ** (`ApiConfigCache`)
   - TTL: 5分
   - 評価: ⚠️ **改善推奨**
   - **問題点**:
     - API設定（ID、名前、モデル、ポート、認証設定）がメモリに保存される
     - メモリダンプで取得される可能性
   - **推奨事項**:
     - キャッシュの暗号化を検討（低優先度）
     - キャッシュのクリア機能

#### 評価: ⚠️ **中程度のリスク**
- メモリ内に一時保存されるのみ
- アプリケーション終了時にクリアされる
- 外部送信は行われない

### 3.2 フロントエンドでのキャッシュ

**ファイル**: `src/utils/tauri.ts`, `src/pages/Diagnostics.tsx`

#### キャッシュ内容
- Tauriコマンドの結果（5秒間）
- 診断情報（30秒間）

#### 評価: ✅ **問題なし**
- 短いTTL
- 技術的な情報のみ

---

## 4. アラート機能のプライバシー

### 4.1 アラート履歴

**ファイル**: `src-tauri/src/commands/alerts.rs`

#### 保存データ
- API ID
- アラートタイプ（response_time、error_rate、cpu_usage、memory_usage）
- 現在値、閾値
- タイムスタンプ
- メッセージ

#### 評価: ✅ **問題なし**
- 技術的な情報のみ
- 個人を特定できる情報は含まれない

### 4.2 アラート設定

#### 保存データ
- 閾値設定
- 通知設定

#### 評価: ✅ **問題なし**
- 設定情報のみ

---

## 5. 証明書生成のプライバシー

### 5.1 証明書に含まれる情報

**ファイル**: `src/backend/auth/certificate-generator.ts`

#### 証明書の内容
- Common Name: "FLM API Server"
- Organization: "FLM"
- Country: "JP"
- Subject Alternative Name:
  - DNS: localhost
  - IP: 127.0.0.1
  - IP: ローカルIPアドレス（オプション）

#### 評価: ✅ **問題なし**
- ローカル情報のみ
- 個人を特定できる情報は含まれない
- 証明書はローカルに保存される

### 5.2 証明書ファイルの保存場所

#### 保存場所
- `%APPDATA%/FLM/certificates/` (Windows)
- `~/Library/Application Support/FLM/certificates/` (macOS)
- `~/.local/share/FLM/certificates/` (Linux)

#### 評価: ⚠️ **改善推奨**
- **推奨事項**:
  - 証明書ファイルのパーミッション設定
  - 秘密鍵の保護強化

---

## 6. レート制限でのデータ収集

### 6.1 レート制限の識別子

#### 識別方法
1. **APIキーがある場合**: APIキーのハッシュ
2. **APIキーがない場合**: IPアドレス

#### 評価: ⚠️ **改善推奨**
- **問題点**:
  - IPアドレスが識別子として使用される
  - ログに含まれる可能性
- **推奨事項**:
  - IPアドレスのハッシュ化
  - ログにIPアドレスを含めない設定

### 6.2 レート制限の保存場所

#### メモリ内ストア
- `Map<string, RateLimitTracking>`
- 評価: ✅ 問題なし（一時的な保存のみ）

#### Redis（オプション）
- `REDIS_URL`環境変数が設定されている場合
- 評価: ⚠️ **改善推奨**
- **推奨事項**:
  - Redis接続の暗号化確認
  - Redisデータの有効期限設定

---

## 7. 前回監査からの改善状況

### 7.1 改善された点

1. **エラーハンドリング**: 機密情報の漏洩を防ぐ設計が確認された（✅）
2. **バックアップ機能**: APIキーは暗号化された状態でバックアップされる（✅）
3. **デバッグログ**: リリースビルドで無効化される（✅）

### 7.2 依然として改善が必要な点

1. **リクエストログの管理**: ログ保存期間の設定がない（⚠️）
2. **データ保持期間**: 不明確（⚠️）
3. **プライバシーポリシー**: パフォーマンスメトリクスの収集が明記されていない（⚠️）
4. **OAuthトークンの保存**: 暗号化の有無が不明確（⚠️）
5. **バックアップファイル**: 暗号化されていない（⚠️）
6. **ウェブサイトでの追跡**: ユーザーに通知されていない（⚠️）

### 7.3 新たに発見された問題

1. **パフォーマンスメトリクスにシステム情報が含まれる**: CPU/メモリ使用率（⚠️）
2. **IPアドレスの使用**: レート制限と証明書生成（⚠️）
3. **キャッシュにAPI設定が保存される**: メモリ内に一時保存（⚠️）

---

## 8. 優先度別改善提案（最終版）

### 🔴 高優先度（即座に対応すべき項目）

1. **ウェブサイトでのダウンロード追跡の改善**
   - プライバシーポリシーに明記
   - オプトイン方式に変更
   - ユーザーへの通知

2. **バックアップファイルの暗号化**
   - バックアップファイルの暗号化オプション
   - パスワード保護機能

3. **バックアップ時のリクエストログ除外オプション**
   - バックアップ時にリクエストボディを除外するオプション
   - デフォルトで除外する設定

4. **プライバシーポリシーの更新**
   - パフォーマンスメトリクスの収集を明記
   - IPアドレスの使用を明記
   - キャッシュ機能を明記

### 🟡 中優先度（近い将来に対応すべき項目）

1. **OAuthトークンの暗号化保存**
   - トークンの保存場所を確認
   - APIキーと同様の暗号化を実装

2. **リクエストログの改善**
   - ログ保存期間の設定機能
   - 自動ログ削除機能
   - マスク処理の強化

3. **IPアドレスのハッシュ化**
   - レート制限でのIPアドレスハッシュ化
   - ログにIPアドレスを含めない設定

4. **パフォーマンスメトリクスのオプトアウト**
   - メトリクス収集の有効/無効設定
   - CPU/メモリ使用率の収集を無効化するオプション

5. **環境変数のドキュメント**
   - 環境変数の一覧と説明
   - 機密情報を含む環境変数の明確化

6. **データ保持期間の明確化**
   - データ保持期間の設定機能
   - 自動削除機能の実装

### 🟢 低優先度（長期的に対応すべき項目）

1. **データベースの暗号化**
   - SQLCipherなどの使用を検討

2. **キャッシュの暗号化**
   - メモリ内キャッシュの暗号化（低優先度）

3. **デバイスIDの改善**
   - オプトアウト機能の提供
   - デバイスIDの使用目的の明確化

---

## 9. コード実装の推奨事項

### 9.1 IPアドレスのハッシュ化

```typescript
// src/backend/auth/rate-limit.ts に追加
import crypto from 'crypto';

function hashIpAddress(ip: string): string {
  return crypto.createHash('sha256').update(ip).digest('hex').substring(0, 16);
}

function getRateLimitIdentifier(apiId: string, apiKey?: string, ip?: string): string {
  if (apiKey) {
    return `${apiId}:key:${hashApiKey(apiKey)}`;
  } else if (ip) {
    return `${apiId}:ip:${hashIpAddress(ip)}`;
  }
  // ...
}
```

### 9.2 パフォーマンスメトリクスのオプトアウト

```typescript
// src/backend/auth/server.ts に追加
interface PerformanceMetricsSettings {
  enabled: boolean;
  collectCpuUsage: boolean;
  collectMemoryUsage: boolean;
}

async function collectPerformanceMetrics(
  apiId: string,
  responseTime: number,
  statusCode: number,
  settings: PerformanceMetricsSettings
): Promise<void> {
  if (!settings.enabled) {
    return;
  }
  
  const metrics = [
    { type: 'avg_response_time', value: responseTime },
    { type: 'request_count', value: 1 },
    { type: 'error_rate', value: statusCode >= 400 ? 1 : 0 },
  ];
  
  if (settings.collectCpuUsage) {
    // CPU使用率を収集
  }
  
  if (settings.collectMemoryUsage) {
    // メモリ使用率を収集
  }
  // ...
}
```

### 9.3 キャッシュのクリア機能

```rust
// src-tauri/src/utils/cache.rs に追加
pub async fn clear_all_caches() -> Result<(), AppError> {
    MODEL_LIST_CACHE.invalidate().await;
    API_CONFIG_CACHE.clear().await;
    Ok(())
}
```

---

## 10. プライバシーポリシーの更新推奨事項（最終版）

### 10.1 追加すべき項目

1. **パフォーマンスメトリクスの収集**
   - 収集されるメトリクスの種類
   - CPU/メモリ使用率の収集
   - メトリクスの保存場所
   - オプトアウト方法

2. **IPアドレスの使用**
   - レート制限での使用目的
   - 証明書生成での使用目的
   - IPアドレスの保存場所
   - ハッシュ化の有無

3. **キャッシュ機能**
   - キャッシュの種類
   - キャッシュに保存されるデータ
   - キャッシュの保持期間
   - キャッシュのクリア方法

4. **ブラウザストレージの使用**
   - localStorageの使用目的
   - 保存されるデータの種類
   - データの保持期間

5. **ウェブサイトでの追跡**
   - ダウンロード追跡の目的
   - 収集されるデータ
   - オプトアウト方法

6. **バックアップ機能**
   - バックアップに含まれるデータ
   - バックアップファイルの保存場所
   - バックアップファイルの暗号化

7. **環境変数**
   - 使用される環境変数
   - 機密情報を含む環境変数
   - 環境変数の管理方法

---

## 11. 結論

### 総合評価

- **暗号化実装**: ✅ 優秀（OSキーストアの使用）
- **データ収集**: ⚠️ 中程度のリスク（パフォーマンスメトリクス、IPアドレスの使用）
- **データ保存**: ⚠️ 中程度のリスク（キャッシュ、バックアップファイルの暗号化）
- **データ送信**: ⚠️ 中程度のリスク（リモート同期の改善が必要）
- **ユーザーコントロール**: ⚠️ 改善が必要（プライバシー設定の追加）

### 前回監査との比較

- **改善された点**: エラーハンドリング、バックアップ機能の詳細が確認された
- **新たに発見された問題**: パフォーマンスメトリクス、IPアドレスの使用、キャッシュ機能
- **依然として改善が必要**: ログ管理、データ保持期間、プライバシーポリシー

### 監査履歴

- **第1回監査**: 基本的なプライバシー監査
- **第2回監査**: 詳細なコード分析
- **第3回監査**: 包括的な分析（バックアップ、ウェブサイト）
- **第4回監査**: 最終詳細分析（パフォーマンスメトリクス、キャッシュ、アラート、証明書生成）

### 次のステップ

1. 高優先度項目の実装（ウェブサイト追跡の改善、バックアップ暗号化、プライバシーポリシー更新）
2. 中優先度項目の実装（IPアドレスハッシュ化、メトリクスオプトアウト）
3. ユーザーへの通知と同意取得
4. 定期的な監査の実施（3ヶ月ごと推奨）

---

## 付録

### A. 確認したファイル一覧（完全版）

#### Rust実装
- `src-tauri/src/database/encryption.rs` - 暗号化実装（✅ 優秀）
- `src-tauri/src/commands/database.rs` - データベース操作
- `src-tauri/src/commands/oauth.rs` - OAuth認証（⚠️ 改善必要）
- `src-tauri/src/commands/backup.rs` - バックアップ機能（⚠️ 改善必要）
- `src-tauri/src/commands/performance.rs` - パフォーマンスメトリクス（⚠️ 改善推奨）
- `src-tauri/src/commands/alerts.rs` - アラート機能（✅ 問題なし）
- `src-tauri/src/utils/remote_sync.rs` - リモート同期（⚠️ 改善必要）
- `src-tauri/src/utils/cache.rs` - キャッシュ機能（⚠️ 改善推奨）
- `src-tauri/src/utils/audit_log.rs` - 監査ログ
- `src-tauri/src/utils/error.rs` - エラーハンドリング（✅ 良好）
- `src-tauri/src/lib.rs` - メインライブラリ（✅ デバッグログ制御良好）

#### TypeScript実装
- `src/backend/auth/server.ts` - 認証サーバー、リクエストログ、パフォーマンスメトリクス（⚠️ 改善推奨）
- `src/backend/auth/database.ts` - データベース操作
- `src/backend/auth/rate-limit.ts` - レート制限（⚠️ IPアドレス使用）
- `src/backend/auth/rate-limit-redis.ts` - Redisレート制限（⚠️ IPアドレス使用）
- `src/backend/auth/certificate-generator.ts` - 証明書生成（✅ 問題なし）
- `src/utils/errorHandler.ts` - エラーハンドリング（✅ 良好）
- `src/utils/logger.ts` - ロガー（⚠️ ログレベル制御改善必要）
- `src/components/onboarding/Onboarding.tsx` - オンボーディング（✅ 問題なし）

#### ウェブサイト
- `WEB/js/download.js` - ダウンロード追跡（⚠️ 改善必要）

#### 設定ファイル
- `src-tauri/tauri.conf.json` - Tauri設定、CSPポリシー（✅ 適切）
- `DOCKS/DATABASE_SCHEMA.sql` - データベーススキーマ

### B. データフロー図（更新版）

```
ユーザー入力
    ↓
フロントエンド（React）
    ↓
Tauri IPC
    ↓
バックエンド（Rust）
    ↓
SQLiteデータベース
    ├─ APIキー（暗号化）✅
    ├─ パフォーマンスメトリクス（CPU/メモリ使用率）⚠️
    ├─ リクエストログ（マスク処理あり）⚠️
    └─ アラート履歴 ✅
    ↓
メモリ内キャッシュ（API設定）⚠️
    ↓
バックアップ（JSON、暗号化なし）⚠️
```

### C. プライバシーリスクマトリックス（更新版）

| データ種別 | 収集 | 保存 | 送信 | リスクレベル |
|-----------|------|------|------|------------|
| APIキー | ✅ | ✅（暗号化） | ❌ | 🟢 低 |
| OAuthトークン | ✅ | ⚠️（不明） | ❌ | 🟡 中 |
| リクエストログ | ✅ | ✅ | ❌ | 🟡 中 |
| パフォーマンスメトリクス | ✅ | ✅ | ❌ | 🟡 中 |
| IPアドレス | ✅ | ⚠️（一時的） | ❌ | 🟡 中 |
| 設定情報 | ✅ | ✅ | ⚠️（リモート同期） | 🟡 中 |
| デバイスID | ✅ | ✅ | ⚠️（リモート同期） | 🟡 中 |
| ダウンロード追跡 | ✅ | ✅（localStorage） | ❌ | 🟢 低 |
| キャッシュ（API設定） | ✅ | ⚠️（メモリ内） | ❌ | 🟢 低 |

### D. 収集されるデータの完全リスト

#### 技術的な情報（個人情報なし）
- API設定（名前、モデル、ポート）
- リクエスト/レスポンス統計
- エラー率
- レスポンス時間

#### システム情報（個人情報なし、ただしシステム情報）
- CPU使用率
- メモリ使用率
- IPアドレス（ローカルのみ）

#### ユーザー設定
- テーマ設定
- 言語設定
- アラート設定

#### 追跡情報
- オンボーディング完了フラグ
- ダウンロード追跡（ウェブサイト）

---

**レポート作成日**: 2025年1月（第4回監査）  
**次回監査推奨日**: 2025年4月（3ヶ月後）  
**監査方法**: コードベース全体の包括的分析、実装コードの詳細確認、データフローの完全な追跡

