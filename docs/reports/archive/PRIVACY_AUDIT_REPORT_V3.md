# プライバシー監査レポート V3（最終詳細版）

**プロジェクト名**: FLM (Local LLM API Manager)  
**監査日**: 2025年1月（第3回監査）  
**バージョン**: 1.0.0  
**監査者**: AI アシスタント  
**監査範囲**: コードベース全体の包括的分析（フロントエンド、バックエンド、設定ファイル、ウェブサイト）

---

## エグゼクティブサマリー

本レポートは、FLMアプリケーションのプライバシーに関する第3回目の包括的な監査結果をまとめたものです。前回の監査を基に、新たに発見された問題点、改善された点、および詳細な実装分析を提示します。

### 総合評価

**プライバシー保護レベル**: ⚠️ **中程度（前回と同様）**

### 新たに発見された重要な問題

1. **バックアップファイルにリクエストログが含まれる**: バックアップ時にリクエストボディが含まれる可能性
2. **ウェブサイトでのダウンロード追跡**: localStorageを使用したダウンロード追跡が実装されている
3. **エラーログにスタックトレースが含まれる**: 開発環境でスタックトレースが出力される
4. **環境変数の使用**: 多くの環境変数が使用されているが、機密情報の扱いが不明確

---

## 1. ブラウザストレージの使用

### 1.1 localStorageの使用

#### 1.1.1 オンボーディング完了フラグ

**ファイル**: `src/components/onboarding/Onboarding.tsx`

**保存データ**:
- `flm_onboarding_completed`: `'true'` (文字列)
- `flm_api_creation_tutorial_completed`: `'true'` (文字列)

**評価**: ✅ **問題なし**
- 個人を特定できる情報は含まれない
- アプリケーションの状態管理のみ

#### 1.1.2 ウェブサイトでのダウンロード追跡

**ファイル**: `WEB/js/download.js`

**保存データ**:
```javascript
{
  os: 'windows' | 'macos' | 'linux',
  timestamp: '2025-01-01T00:00:00.000Z'
}
```

**評価**: ⚠️ **改善推奨**
- **問題点**:
  - ユーザーに通知されていない
  - プライバシーポリシーに明記されていない
  - オプトアウト機能がない
- **推奨事項**:
  - プライバシーポリシーに明記
  - オプトイン方式に変更
  - ユーザーに通知

---

## 2. バックアップ機能の詳細分析

### 2.1 バックアップに含まれるデータ

**ファイル**: `src-tauri/src/commands/backup.rs`

#### バックアップ内容
1. **API設定情報** (`apis`)
   - ID、名前、モデル名、ポート番号、認証設定、ステータス
   - 評価: ✅ 問題なし

2. **APIキー** (`api_keys`)
   - 暗号化されたキー（Base64エンコード）
   - 評価: ✅ **良好**（暗号化されている）

3. **インストール済みモデル情報** (`installed_models`)
   - モデル名、サイズ、パラメータ数、使用統計
   - 評価: ✅ 問題なし

4. **リクエストログ** (`request_logs`)
   - 最新1000件まで
   - **リクエストボディを含む**（マスク処理あり）
   - 評価: ⚠️ **要改善**
   - **問題点**:
     - リクエストボディに個人情報が含まれる可能性
     - バックアップファイルに含まれると、長期保存される
   - **推奨事項**:
     - バックアップ時にリクエストボディを除外するオプション
     - バックアップ前に機密情報をマスク
     - バックアップファイルの暗号化

5. **アラート履歴** (`alert_history`)
   - 最新1000件まで
   - 評価: ✅ 問題なし

### 2.2 バックアップファイルの形式

**形式**: JSON（プレーンテキスト）

**評価**: ⚠️ **改善推奨**
- **問題点**:
  - プレーンテキストで保存される
  - 暗号化されていない
  - ファイルアクセス権限の管理が必要
- **推奨事項**:
  - バックアップファイルの暗号化オプション
  - パスワード保護機能
  - ファイルパーミッションの適切な設定

---

## 3. エラーハンドリングとログ出力

### 3.1 エラーログの内容

**ファイル**: `src/utils/errorHandler.ts`

#### 開発環境でのログ出力
```typescript
if (isDev) {
  logger.debug('Error details:', {
    category: error.category,
    retryable: error.retryable,
    timestamp: error.timestamp,
    suggestion: error.suggestion,
    technicalDetails: error.technicalDetails, // スタックトレースを含む
  });
}
```

**評価**: ✅ **良好**
- 開発環境でのみ詳細情報が出力される
- 本番環境ではユーザーフレンドリーなメッセージのみ

### 3.2 Rust側のエラーハンドリング

**ファイル**: `src-tauri/src/utils/error.rs`

#### エラー情報の構造
```rust
pub enum AppError {
    ApiError { 
        message: String, 
        code: String,
        #[serde(skip)]
        source_detail: Option<String>, // シリアライズされない
    },
    // ...
}
```

**評価**: ✅ **良好**
- `source_detail`はシリアライズされない（フロントエンドに送信されない）
- 機密情報の漏洩を防ぐ設計

---

## 4. 環境変数の使用

### 4.1 使用されている環境変数

#### バックエンド（Node.js）
- `NODE_ENV`: 環境判定（development/production）
- `PORT`: サーバーポート
- `API_ID`: API識別子
- `ENGINE_BASE_URL`: エンジンURL
- `OLLAMA_URL`: Ollama URL
- `FLM_DATA_DIR`: データディレクトリ
- `ALLOWED_ORIGINS`: CORS許可オリジン
- `REDIS_URL`: Redis接続URL（オプション）
- `RATE_LIMIT_ENABLED`: レート制限有効/無効
- `RATE_LIMIT_REQUESTS`: レート制限リクエスト数
- `RATE_LIMIT_WINDOW_SECONDS`: レート制限ウィンドウ

#### フロントエンド（Vite）
- `VITE_WEB_API_BASE_URL`: Web APIベースURL

### 4.2 環境変数の機密性評価

**評価**: ⚠️ **改善推奨**
- **問題点**:
  - `REDIS_URL`に認証情報が含まれる可能性
  - `ALLOWED_ORIGINS`の設定が不明確
  - 環境変数のドキュメントが不足
- **推奨事項**:
  - 環境変数のドキュメント作成
  - 機密情報を含む環境変数の明確化
  - 環境変数のバリデーション強化

---

## 5. ウェブサイト（WEBディレクトリ）のプライバシー

### 5.1 ダウンロード追跡

**ファイル**: `WEB/js/download.js`

#### 実装詳細
- **追跡内容**: OS情報、タイムスタンプ
- **保存場所**: localStorage
- **通知**: なし

**評価**: ⚠️ **改善推奨**
- **推奨事項**:
  - プライバシーポリシーに明記
  - オプトイン方式に変更
  - Cookie同意バナーの実装（GDPR対応）

### 5.2 外部API接続

#### GitHub Releases API
- **URL**: `https://api.github.com/repos/Unjuno/FLM/releases/latest`
- **送信データ**: なし（GETリクエストのみ）
- **評価**: ✅ 問題なし

---

## 6. データエクスポート機能

### 6.1 API設定のエクスポート

**ファイル**: `src-tauri/src/commands/api.rs`

#### エクスポート内容
```rust
pub struct ApiSettingsExport {
    pub apis: Vec<ApiExportData>,
    pub export_date: String,
    pub version: String,
}
```

**評価**: ✅ **良好**
- APIキーは含まれない
- 設定情報のみ

### 6.2 ログのエクスポート

**ファイル**: `src-tauri/src/commands/api.rs`

#### エクスポート内容
- リクエストログ（リクエストボディを含む、マスク処理あり）
- フィルタリング機能あり

**評価**: ⚠️ **改善推奨**
- **推奨事項**:
  - エクスポート時にリクエストボディを除外するオプション
  - マスク処理の強化

---

## 7. 前回監査からの改善状況

### 7.1 改善された点

1. **暗号化実装**: OSキーストアの使用が確認された（✅）
2. **デバッグログの制御**: リリースビルドで無効化される（✅）
3. **エラーハンドリング**: 機密情報の漏洩を防ぐ設計（✅）

### 7.2 依然として改善が必要な点

1. **リクエストログの管理**: ログ保存期間の設定がない（⚠️）
2. **データ保持期間**: 不明確（⚠️）
3. **プライバシーポリシー**: ウェブサイトでの追跡が明記されていない（⚠️）
4. **OAuthトークンの保存**: 暗号化の有無が不明確（⚠️）
5. **バックアップファイル**: 暗号化されていない（⚠️）

### 7.3 新たに発見された問題

1. **ウェブサイトでのダウンロード追跡**: ユーザーに通知されていない（⚠️）
2. **バックアップにリクエストログが含まれる**: 長期保存される可能性（⚠️）
3. **環境変数のドキュメント不足**: 機密情報の扱いが不明確（⚠️）

---

## 8. 優先度別改善提案（更新版）

### 🔴 高優先度（即座に対応すべき項目）

1. **ウェブサイトでのダウンロード追跡の改善**
   - プライバシーポリシーに明記
   - オプトイン方式に変更
   - ユーザーへの通知

2. **バックアップファイルの暗号化**
   - バックアップファイルの暗号化オプション
   - パスワード保護機能

3. **バックアップ時のリクエストログ除外オプション**
   - バックアップ時にリクエストボディを除外するオプション
   - デフォルトで除外する設定

### 🟡 中優先度（近い将来に対応すべき項目）

1. **OAuthトークンの暗号化保存**
   - トークンの保存場所を確認
   - APIキーと同様の暗号化を実装

2. **リクエストログの改善**
   - ログ保存期間の設定機能
   - 自動ログ削除機能
   - マスク処理の強化

3. **環境変数のドキュメント**
   - 環境変数の一覧と説明
   - 機密情報を含む環境変数の明確化

4. **データ保持期間の明確化**
   - データ保持期間の設定機能
   - 自動削除機能の実装

### 🟢 低優先度（長期的に対応すべき項目）

1. **データベースの暗号化**
   - SQLCipherなどの使用を検討

2. **デバイスIDの改善**
   - オプトアウト機能の提供
   - デバイスIDの使用目的の明確化

---

## 9. コード実装の推奨事項

### 9.1 バックアップファイルの暗号化

```rust
// src-tauri/src/commands/backup.rs に追加
pub async fn create_encrypted_backup(
    output_path: String,
    password: String,
) -> Result<BackupResponse, String> {
    let backup_data = create_backup_data().await?;
    let encrypted = encrypt_backup(&backup_data, &password)?;
    // ...
}
```

### 9.2 バックアップ時のリクエストログ除外

```rust
// src-tauri/src/commands/backup.rs に追加
pub struct BackupOptions {
    pub include_request_logs: bool,
    pub include_request_bodies: bool,
    pub encrypt: bool,
}

pub async fn create_backup_with_options(
    output_path: String,
    options: BackupOptions,
) -> Result<BackupResponse, String> {
    // オプションに応じてデータをフィルタリング
    // ...
}
```

### 9.3 ウェブサイトでの追跡のオプトイン

```javascript
// WEB/js/download.js に追加
function trackDownload(os) {
  // ユーザーの同意を確認
  const consent = localStorage.getItem('flm_tracking_consent');
  if (consent !== 'true') {
    return; // 同意がない場合は追跡しない
  }
  
  // 既存の追跡コード
  // ...
}
```

---

## 10. プライバシーポリシーの更新推奨事項

### 10.1 追加すべき項目

1. **ブラウザストレージの使用**
   - localStorageの使用目的
   - 保存されるデータの種類
   - データの保持期間

2. **ウェブサイトでの追跡**
   - ダウンロード追跡の目的
   - 収集されるデータ
   - オプトアウト方法

3. **バックアップ機能**
   - バックアップに含まれるデータ
   - バックアップファイルの保存場所
   - バックアップファイルの暗号化

4. **環境変数**
   - 使用される環境変数
   - 機密情報を含む環境変数
   - 環境変数の管理方法

---

## 11. 結論

### 総合評価

- **暗号化実装**: ✅ 優秀（OSキーストアの使用）
- **データ収集**: ⚠️ 中程度のリスク（ウェブサイトでの追跡が改善必要）
- **データ保存**: ⚠️ 中程度のリスク（バックアップファイルの暗号化が必要）
- **データ送信**: ⚠️ 中程度のリスク（リモート同期の改善が必要）
- **ユーザーコントロール**: ⚠️ 改善が必要（プライバシー設定の追加）

### 前回監査との比較

- **改善された点**: エラーハンドリングの詳細が確認された
- **新たに発見された問題**: ウェブサイトでの追跡、バックアップファイルの暗号化
- **依然として改善が必要**: ログ管理、データ保持期間、プライバシーポリシー

### 次のステップ

1. 高優先度項目の実装（ウェブサイト追跡の改善、バックアップ暗号化）
2. プライバシーポリシーの更新
3. 環境変数のドキュメント作成
4. ユーザーへの通知と同意取得
5. 定期的な監査の実施（3ヶ月ごと推奨）

---

## 付録

### A. 確認したファイル一覧（完全版）

#### Rust実装
- `src-tauri/src/database/encryption.rs` - 暗号化実装（✅ 優秀）
- `src-tauri/src/commands/database.rs` - データベース操作
- `src-tauri/src/commands/oauth.rs` - OAuth認証（⚠️ 改善必要）
- `src-tauri/src/commands/backup.rs` - バックアップ機能（⚠️ 改善必要）
- `src-tauri/src/utils/remote_sync.rs` - リモート同期（⚠️ 改善必要）
- `src-tauri/src/utils/audit_log.rs` - 監査ログ
- `src-tauri/src/utils/error.rs` - エラーハンドリング（✅ 良好）
- `src-tauri/src/lib.rs` - メインライブラリ（✅ デバッグログ制御良好）

#### TypeScript実装
- `src/backend/auth/server.ts` - 認証サーバー、リクエストログ（⚠️ ログ制御改善必要）
- `src/backend/auth/database.ts` - データベース操作
- `src/utils/errorHandler.ts` - エラーハンドリング（✅ 良好）
- `src/utils/logger.ts` - ロガー（⚠️ ログレベル制御改善必要）
- `src/components/onboarding/Onboarding.tsx` - オンボーディング（✅ 問題なし）

#### ウェブサイト
- `WEB/js/download.js` - ダウンロード追跡（⚠️ 改善必要）

#### 設定ファイル
- `src-tauri/tauri.conf.json` - Tauri設定、CSPポリシー（✅ 適切）
- `DOCKS/DATABASE_SCHEMA.sql` - データベーススキーマ

### B. データフロー図

```
ユーザー入力
    ↓
フロントエンド（React）
    ↓
Tauri IPC
    ↓
バックエンド（Rust）
    ↓
SQLiteデータベース（暗号化されたAPIキー）
    ↓
バックアップ（JSON、暗号化なし）⚠️
```

### C. プライバシーリスクマトリックス

| データ種別 | 収集 | 保存 | 送信 | リスクレベル |
|-----------|------|------|------|------------|
| APIキー | ✅ | ✅（暗号化） | ❌ | 🟢 低 |
| OAuthトークン | ✅ | ⚠️（不明） | ❌ | 🟡 中 |
| リクエストログ | ✅ | ✅ | ❌ | 🟡 中 |
| 設定情報 | ✅ | ✅ | ⚠️（リモート同期） | 🟡 中 |
| デバイスID | ✅ | ✅ | ⚠️（リモート同期） | 🟡 中 |
| ダウンロード追跡 | ✅ | ✅（localStorage） | ❌ | 🟢 低 |

### D. 監査履歴

- **第1回監査**: 2025年1月 - 基本的なプライバシー監査
- **第2回監査**: 2025年1月 - 詳細なコード分析
- **第3回監査**: 2025年1月 - 包括的な分析（本レポート）

---

**レポート作成日**: 2025年1月（第3回監査）  
**次回監査推奨日**: 2025年4月（3ヶ月後）  
**監査方法**: コードベース全体の包括的分析、実装コードの詳細確認、データフローの追跡

