# FLM セキュリティ監査レポート

**監査日**: 2024年  
**監査対象**: FLM (Local LLM API Manager)  
**監査範囲**: 認証・認可、暗号化、入力検証、SQLインジェクション対策、XSS対策、CORS設定、エラーハンドリング  
**最終更新**: 2024年（改善実装後）

---

## エグゼクティブサマリー

FLMアプリケーションは、基本的なセキュリティ対策が実装されていますが、いくつかの改善点があります。特に、CORS設定の緩和、暗号化キーの管理方法、エラーメッセージの詳細度などに改善の余地があります。

### 総合評価: ⚠️ 中程度のリスク

**強み**:
- HTTPS必須実装
- APIキーの適切なハッシュ化と暗号化
- SQLインジェクション対策（パラメータ化クエリ）
- タイミング攻撃対策
- セキュリティヘッダーの設定

**改善が必要な項目**:
- CORS設定が過度に緩和されている
- 暗号化キーの保存場所がファイルシステム（OSキーストア推奨）
- エラーメッセージに詳細情報が含まれる可能性
- 入力検証の強化が必要な箇所

---

## 1. 認証・認可

### 1.1 APIキー認証

**実装状況**: ✅ 良好

**確認内容**:
- APIキーは32文字以上のランダム文字列として生成
- SHA-256ハッシュ化して保存（平文は保存されない）
- AES-256-GCMで暗号化保存
- タイミング攻撃対策として`crypto.timingSafeEqual`を使用

**ファイル**:
- `src/backend/auth/keygen.ts`: APIキー生成・検証
- `src-tauri/src/database/encryption.rs`: 暗号化・復号化

**推奨事項**:
- ✅ 現在の実装で十分
- 将来的に、APIキーの有効期限機能を検討

### 1.2 OAuth2認証

**実装状況**: ✅ 良好

**確認内容**:
- OAuth2トークン検証機能が実装されている
- データベース検証、イントロスペクション、JWT検証に対応

**ファイル**:
- `src/backend/auth/oauth-validator.ts`

**推奨事項**:
- ✅ 現在の実装で十分

### 1.3 認証ミドルウェア

**実装状況**: ✅ 良好

**確認内容**:
- Bearer トークン形式でAPIキーを検証
- 認証失敗時は適切なエラーメッセージを返却

**ファイル**:
- `src/backend/auth/server.ts` (631-664行目)

**推奨事項**:
- ✅ 現在の実装で十分

---

## 2. 暗号化

### 2.1 APIキーの暗号化

**実装状況**: ⚠️ 改善の余地あり

**確認内容**:
- AES-256-GCMを使用（強力な暗号化方式）
- 暗号化キーはファイルシステムに保存

**ファイル**:
- `src-tauri/src/database/encryption.rs` (11-49行目)

**問題点**:
```rust
// 簡易実装: アプリケーションデータディレクトリからキーを読み込むか生成
// 本番環境では、OSのキーストア（Windows Credential Manager、macOS Keychain等）を使用推奨
```

**推奨事項**:
- 🔴 **高優先度**: OSのキーストア（Windows Credential Manager、macOS Keychain、Linux Secret Service）を使用することを推奨
- 現在の実装でも動作するが、セキュリティレベルを向上させるため改善を推奨

### 2.2 通信の暗号化

**実装状況**: ✅ 良好

**確認内容**:
- HTTPS必須実装（HTTPは完全に無効化）
- 自己署名証明書を自動生成
- HTTP→HTTPS自動リダイレクト

**ファイル**:
- `src/backend/auth/server.ts` (771-816行目)
- `src/backend/auth/certificate-generator.ts`

**推奨事項**:
- ✅ 現在の実装で十分
- 将来的にLet's Encrypt統合を検討

---

## 3. SQLインジェクション対策

### 3.1 パラメータ化クエリ

**実装状況**: ✅ 良好

**確認内容**:
- Rust側: `rusqlite`の`params!`マクロを使用
- Node.js側: `sqlite3`のプレースホルダー（`?`）を使用

**ファイル**:
- `src-tauri/src/database/repository/api_repository.rs`
- `src/backend/auth/database.ts`

**例**:
```rust
// Rust側: パラメータ化クエリ
let mut stmt = conn.prepare("SELECT * FROM apis WHERE id = ?")?;
let api = stmt.query_row(params![id], |row| { ... })?;
```

```typescript
// Node.js側: パラメータ化クエリ
db.get('SELECT key_hash FROM api_keys WHERE key_hash = ?', [apiKeyHash], ...);
```

**推奨事項**:
- ✅ 現在の実装で十分
- 動的クエリ構築時も注意が必要（`src-tauri/src/database/repository.rs`の673-780行目など）

### 3.2 動的クエリの安全性

**実装状況**: ⚠️ 注意が必要

**確認内容**:
- 一部の動的クエリ構築が存在（フィルタリング機能など）
- パラメータ化は適切に使用されているが、クエリ構築ロジックの複雑さに注意

**ファイル**:
- `src-tauri/src/database/repository.rs` (673-780行目)

**推奨事項**:
- 🟡 **中優先度**: 動的クエリ構築部分のコードレビューを定期的に実施
- ホワイトリスト方式でのフィルタリングを推奨

---

## 4. XSS（クロスサイトスクリプティング）対策

### 4.1 セキュリティヘッダー

**実装状況**: ✅ 良好

**確認内容**:
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `X-XSS-Protection: 1; mode=block`
- `Referrer-Policy: strict-origin-when-cross-origin`

**ファイル**:
- `src/backend/auth/server.ts` (194-205行目)

**推奨事項**:
- ✅ 現在の実装で十分
- 将来的に`Content-Security-Policy`ヘッダーの追加を検討

### 4.2 フロントエンドのXSS対策

**実装状況**: ⚠️ 改善の余地あり

**確認内容**:
- `innerHTML`の使用がテストファイルとユーティリティファイルに存在
- 本番コードでの`dangerouslySetInnerHTML`の使用は確認されず

**ファイル**:
- `src/utils/print.ts` (273行目)
- `WEB/js/*.js` (複数ファイル)

**推奨事項**:
- 🟡 **中優先度**: `innerHTML`の使用箇所を確認し、可能な限り`textContent`やReactの安全な方法に置き換え
- ユーザー入力が含まれる場合は必ずサニタイズ

---

## 5. CORS設定

### 5.1 現在の設定

**実装状況**: ✅ 改善済み

**実装内容**:
- 環境変数 `ALLOWED_ORIGINS` で許可オリジンを設定可能
- 開発環境ではすべてのオリジンを許可（`*`）
- 本番環境では環境変数で指定されたオリジンのみを許可（未設定の場合はすべて拒否）

**実装ファイル**:
- `src/backend/auth/server.ts` (191-222行目)
- `src/backend/auth/proxy.ts` (34-73行目)

**使用方法**:
```bash
# 環境変数で許可オリジンを指定（カンマ区切り）
export ALLOWED_ORIGINS=https://example.com,https://app.example.com

# または .env ファイルに記述
ALLOWED_ORIGINS=https://example.com,https://app.example.com
```

**動作**:
- `ALLOWED_ORIGINS` が設定されている場合: 指定されたオリジンのみを許可
- 開発環境（`NODE_ENV=development`）で未設定の場合: すべてのオリジンを許可（`*`）
- 本番環境で未設定の場合: すべてのオリジンを拒否（空配列）

**推奨事項**:
- ✅ 実装完了
- 本番環境では必ず `ALLOWED_ORIGINS` 環境変数を設定することを推奨

---

## 6. 入力検証

### 6.1 ポート番号の検証

**実装状況**: ✅ 良好

**確認内容**:
- ポート番号の範囲チェック（1024-65535）
- 無効な値の場合はデフォルト値を使用

**ファイル**:
- `src/backend/auth/server.ts` (44-59行目)

**推奨事項**:
- ✅ 現在の実装で十分

### 6.2 API IDのサニタイズ

**実装状況**: ✅ 良好

**確認内容**:
- パストラバーサル攻撃対策として危険な文字を削除
- 正規表現で許可された文字のみを許可

**ファイル**:
- `src/backend/auth/server.ts` (152-155行目)

```typescript
function sanitizeApiId(apiId: string): string {
  return apiId.replace(/[./\\:]/g, '').replace(/[^a-zA-Z0-9_-]/g, '');
}
```

**推奨事項**:
- ✅ 現在の実装で十分

### 6.3 その他の入力検証

**実装状況**: ⚠️ 改善の余地あり

**確認内容**:
- リクエストボディのサイズ制限（10KB）が設定されている
- JSONパーサーのサイズ制限（10MB）が設定されている

**推奨事項**:
- 🟡 **中優先度**: リクエストボディのサイズ制限を環境変数で設定可能にする
- 入力値の型検証を強化

---

## 7. エラーハンドリング

### 7.1 エラーメッセージの情報漏洩

**実装状況**: ✅ 改善済み

**実装内容**:
- 本番環境では詳細なエラー情報（スタックトレース等）を出力しない
- 開発環境では詳細なエラー情報を出力（デバッグ用）
- ユーザーには常に汎用的なエラーメッセージを返却（情報漏洩を防止）

**実装ファイル**:
- `src/backend/auth/server.ts` (785-808行目)

**動作**:
- 開発環境（`NODE_ENV=development`）: エラーオブジェクトとスタックトレースを出力
- 本番環境: 汎用的なエラーログのみ出力
- ユーザーへのレスポンス: 常に汎用的なメッセージ（環境に関係なく）

**推奨事項**:
- ✅ 実装完了
- 本番環境ではエラーの詳細を別途ログファイルに記録することを推奨

---

## 8. セキュリティテスト

### 8.1 テストの実装状況

**実装状況**: ✅ 良好

**確認内容**:
- セキュリティテストが実装されている
- APIキーの長さ検証
- SQLインジェクション試行のテスト
- エラーメッセージのセキュリティテスト

**ファイル**:
- `tests/security/security.test.ts`

**推奨事項**:
- ✅ 現在の実装で十分
- 定期的なセキュリティテストの実行を推奨

---

## 9. 依存関係のセキュリティ

### 9.1 依存関係の確認

**実装状況**: ✅ 改善済み

**実装内容**:
- npm auditスクリプトを追加
- cargo auditスクリプトを追加
- セキュリティチェックスクリプト（シェル/PowerShell）を追加

**実装ファイル**:
- `package.json` (70-73行目)
- `scripts/security-check.sh`
- `scripts/security-check.ps1`

**使用方法**:
```bash
# npm依存関係の脆弱性チェック
npm run security:audit

# npm依存関係の脆弱性を自動修正
npm run security:audit:fix

# Cargo依存関係の脆弱性チェック
npm run security:audit:cargo

# すべての依存関係の脆弱性チェック
npm run security:check

# またはスクリプトを直接実行
./scripts/security-check.sh  # Linux/macOS
.\scripts\security-check.ps1  # Windows PowerShell
```

**推奨事項**:
- ✅ 実装完了
- 定期的に（週1回以上）`npm run security:check`を実行することを推奨
- CI/CDパイプラインに組み込むことを推奨

---

## 10. その他のセキュリティ考慮事項

### 10.1 ログ管理

**実装状況**: ✅ 良好

**確認内容**:
- リクエストログにAPIキーは含まれない（ハッシュのみ）
- リクエストボディは10KB以下のみ保存

**推奨事項**:
- ✅ 現在の実装で十分
- 個人情報が含まれる可能性があるログの自動マスキング機能を検討

### 10.2 セッション管理

**実装状況**: N/A

**確認内容**:
- シングルユーザー環境のため、セッション管理は不要

**推奨事項**:
- ✅ 現在の実装で十分

### 10.3 レート制限

**実装状況**: ❌ 未実装

**推奨事項**:
- 🟡 **中優先度**: 将来的にレート制限機能の実装を検討
- DDoS攻撃やブルートフォース攻撃の対策として有効

---

## 優先度別の改善推奨事項

### 🔴 高優先度（即座に対応推奨）

1. ~~**CORS設定の改善**~~ ✅ **完了**
   - ワイルドカード（`*`）の使用をやめ、特定のオリジンのみを許可
   - 環境変数で設定可能にする
   - **実装済み**: `ALLOWED_ORIGINS`環境変数で制御可能

2. ~~**依存関係の脆弱性チェック**~~ ✅ **完了**
   - `npm audit`と`cargo audit`の定期実行
   - 脆弱性の自動検知と通知
   - **実装済み**: `npm run security:check`スクリプトを追加

3. **暗号化キーの管理改善**
   - OSのキーストア（Windows Credential Manager、macOS Keychain等）を使用
   - **未実装**: 将来的な改善として検討

### 🟡 中優先度（計画的な改善）

1. ~~**エラーメッセージの詳細度管理**~~ ✅ **完了**
   - 本番環境では詳細情報を出力しない
   - エラーログは別途記録
   - **実装済み**: 環境に応じたエラーログ出力を実装

2. **入力検証の強化**
   - リクエストボディのサイズ制限を環境変数で設定可能にする
   - 型検証の強化

3. **XSS対策の強化**
   - `innerHTML`の使用箇所を確認し、可能な限り安全な方法に置き換え

4. **レート制限機能の実装**
   - DDoS攻撃やブルートフォース攻撃の対策

### 🟢 低優先度（将来的な改善）

1. **Content-Security-Policyヘッダーの追加**
2. **Let's Encrypt統合**
3. **APIキーの有効期限機能**

---

## 結論

FLMアプリケーションは、基本的なセキュリティ対策が適切に実装されています。特に、HTTPS必須実装、APIキーの適切なハッシュ化と暗号化、SQLインジェクション対策などは良好です。

ただし、CORS設定の緩和、暗号化キーの管理方法、エラーメッセージの詳細度などに改善の余地があります。特に、CORS設定と依存関係の脆弱性チェックは高優先度で対応することを推奨します。

定期的なセキュリティ監査と、推奨事項の段階的な実装により、セキュリティレベルをさらに向上させることができます。

---

**監査実施者**: AI Security Auditor  
**最終更新**: 2024年

