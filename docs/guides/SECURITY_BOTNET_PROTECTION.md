# ボットネット対策ガイド

> Status: Canonical | Audience: All users | Updated: 2025-02-01

## 1. 概要

FLMプロキシサーバーは、外部公開時に自動的にボットネット化を防ぐためのセキュリティ機能を有効化します。

### 1.1 自動有効化

外部公開時（`0.0.0.0`にバインド）は、以下の機能が自動的に有効化されます：

- ✅ 自動IPブロック
- ✅ 侵入検知システム
- ✅ 異常検知システム
- ✅ リソース保護
- ✅ 監査ログ
- ✅ IPベースレート制限

### 1.2 ローカル利用時

ローカル利用時（`127.0.0.1`にバインド）は、基本的なセキュリティ機能のみが有効です：

- ✅ APIキー認証
- ✅ レート制限（APIキーベース）
- ⚠️ ボットネット対策機能は無効（不要のため）

## 2. 機能説明

### 2.1 自動IPブロック

#### 動作

認証失敗が一定回数に達すると、自動的にIPアドレスをブロックします。

| 失敗回数 | ブロック時間 | 自動解除 |
|---------|------------|---------|
| 1-4回 | なし（警告のみ） | - |
| 5回 | 30分 | ✅ 自動 |
| 10回 | 24時間 | ✅ 自動 |
| 20回 | 永続 | ❌ 手動解除のみ |

#### ブロック解除

```bash
# ブロックされたIP一覧を表示
flm security ip-blocklist list

# 特定のIPのブロックを解除
flm security ip-blocklist unblock <ip>

# すべての一時ブロックを解除（永続ブロックは除く）
flm security ip-blocklist clear
```

### 2.2 侵入検知システム

#### 検出パターン

以下のような不正アクセスの試行を検出します：

- SQLインジェクション試行（`'`, `;`, `--`等）
- パストラバーサル試行（`../`, `..\\`等）
- 異常なUser-Agent（スキャナーツール等）
- 存在しないエンドポイントへの大量アクセス

#### アクション

- **スコア 0-49**: ログ記録のみ
- **スコア 50-99**: 警告ログ + 監視強化
- **スコア 100-199**: 1時間ブロック
- **スコア 200以上**: 24時間ブロック

### 2.3 異常検知システム

#### 検出項目

以下のような異常なリクエストパターンを検出します：

- 大量リクエスト（1秒100リクエスト以上）
- 異常に大きなリクエストボディ
- 異常に長いリクエスト時間
- 異常なエンドポイントへのアクセス

#### アクション

異常検出時は自動的にブロックし、ログに記録します。

### 2.4 リソース保護

#### 監視項目

- **CPU使用率**: 90%超で警告 + 新規接続の一時拒否
- **メモリ使用率**: 90%超で警告 + 新規接続の一時拒否
- **同時接続数**: 100接続超で新規接続拒否

### 2.5 監査ログ

#### 記録項目

すべてのセキュリティイベントを記録します：

- 認証成功/失敗
- IPブロック
- 侵入検知イベント
- 異常検知イベント
- リソースアラート

#### ログの確認

```bash
# 監査ログの一覧表示
flm security audit-logs list

# 重大度でフィルタ
flm security audit-logs list --severity high

# 特定のIPでフィルタ
flm security audit-logs list --ip <ip>

# ログのエクスポート
flm security audit-logs export --format json --output audit.json
```

## 3. 設定

### 3.1 セキュリティポリシーの設定

セキュリティポリシーのJSONで設定を変更できます：

```json
{
  "ip_blocklist": {
    "enabled": true,
    "max_failures": 5,
    "block_duration_minutes": 30,
    "permanent_block_threshold": 20
  },
  "intrusion_detection": {
    "enabled": true,
    "score_threshold": 100,
    "warning_threshold": 50
  },
  "anomaly_detection": {
    "enabled": true,
    "request_rate_threshold": 100,
    "auto_block": true
  },
  "resource_protection": {
    "enabled": true,
    "cpu_threshold": 90,
    "memory_threshold": 90
  },
  "ip_rate_limit": {
    "enabled": true,
    "rpm": 1000
  }
}
```

### 3.2 機能の無効化

特定の機能を無効化したい場合：

```bash
# セキュリティポリシーを編集
flm security policy get default > policy.json
# policy.jsonを編集
flm security policy set default < policy.json
```

## 4. トラブルシューティング

### 4.1 正当なユーザーがブロックされた場合

1. **ブロックリストを確認**
   ```bash
   flm security ip-blocklist list
   ```

2. **ブロックを解除**
   ```bash
   flm security ip-blocklist unblock <ip>
   ```

3. **ホワイトリストに追加**（将来実装予定）
   - 現在は手動でブロック解除が必要

### 4.2 誤検知が多い場合

1. **閾値を調整**
   - セキュリティポリシーのJSONで閾値を緩和

2. **機能を無効化**
   - 特定の機能のみ無効化可能

### 4.3 ログが多すぎる場合

1. **ログのローテーション**
   - 7日以上古いログは自動削除

2. **ログレベルの調整**（将来実装予定）
   - 現在はすべてのイベントを記録

## 5. ベストプラクティス

### 5.1 外部公開時

1. **IPホワイトリストを設定**
   - 信頼できるIPアドレスのみ許可

2. **強力なAPIキーを使用**
   - 長く、ランダムなAPIキーを生成

3. **定期的にログを確認**
   - 異常なアクセスパターンを早期に発見

### 5.2 セキュリティ監視

1. **ダッシュボードで監視**
   - ブロック状況を定期的に確認

2. **アラートの設定**（将来実装予定）
   - 重大なセキュリティイベントを通知

## 6. よくある質問

### Q: ボットネット対策機能は常に有効ですか？

A: 外部公開時（`0.0.0.0`にバインド）のみ自動的に有効化されます。ローカル利用時は無効です。

### Q: 誤検知でブロックされた場合、どうすればいいですか？

A: `flm security ip-blocklist unblock <ip>` コマンドでブロックを解除できます。

### Q: ログはどこに保存されますか？

A: `security.db`の`audit_logs`テーブルに保存されます。7日以上古いログは自動削除されます。

### Q: パフォーマンスへの影響はありますか？

A: 最小限の影響（< 10ms）を目指しています。非同期処理とメモリ内キャッシュを使用しています。

---

**関連ドキュメント**:
- `docs/planning/BOTNET_PROTECTION_IMPLEMENTATION_PLAN.md` - 実装計画（開発者向け）
- `docs/specs/CORE_API.md` - API仕様
- `docs/specs/PROXY_SPEC.md` - プロキシ仕様
- `docs/guides/SECURITY_FIREWALL_GUIDE.md` - ファイアウォール設定ガイド

