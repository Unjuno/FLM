# セキュリティ監査レポート（再監査版）

> Status: Complete | Date: 2025-01-27 | Phase: Revised Security Audit

## 監査概要

前回の包括的セキュリティ監査を再実施し、追加の問題点と見落としがないか確認しました。

## 新たに発見された問題

### 高優先度

#### 1. unwrap()の使用によるパニックリスク（詳細）

**発見箇所**:
- `crates/flm-proxy/src/controller.rs:654` - `strip_prefix("flm://").unwrap()`
  - `starts_with("flm://")`でチェックしているが、その後の`unwrap()`は危険
  - 理論的には発生しないが、並行処理やバグで発生する可能性がある
- `crates/flm-proxy/src/engine_repo.rs:33,37` - RwLockのロック
  - `read().unwrap()`と`write().unwrap()`を使用
  - デッドロックやポイズン（panic）が発生した場合、サーバーがクラッシュする可能性

**影響**: サーバーの予期せぬクラッシュ、サービス停止

**推奨修正**:
- `unwrap()`を適切なエラーハンドリングに置き換える
- RwLockのロック失敗時はエラーを返すか、ログを出力して処理を継続

#### 2. 入力検証の不足

**問題**:
- `engine_id`と`model_name`の検証が不十分（空文字列、特殊文字のチェック）
- メッセージの`content`フィールドのサイズ制限がない
- `stop`配列のサイズ制限がない
- `messages`配列のサイズ制限がない

**影響**:
- DoS攻撃のリスク（大きな配列や文字列によるメモリ枯渇）
- 不正な入力による予期せぬ動作

**推奨修正**:
- 入力値のサイズ制限を設定
- 文字列の長さ制限を設定
- 配列の要素数制限を設定

#### 3. 競合状態の可能性

**問題**:
- レート制限の状態管理で`RwLock`を使用しているが、長時間ロックを保持する可能性
- エンジンリポジトリの登録時に競合状態が発生する可能性

**影響**:
- デッドロックのリスク
- パフォーマンスの低下

**推奨修正**:
- ロックの保持時間を最小化
- 必要に応じて非同期ロックを使用

### 中優先度

#### 4. エラーメッセージの情報漏洩（追加）

**問題**:
- ストリーミングエンドポイントでエンジンエラーの詳細が漏洩する可能性
- `crates/flm-proxy/src/controller.rs:884-888`でエラー理由をそのまま返している

**影響**: システム内部情報の漏洩

**推奨修正**:
- エラーメッセージを一般化
- 詳細なエラー情報はログにのみ記録

## 前回の監査で発見された問題（再確認）

### 高優先度

1. **セキュリティヘッダーの不足** - 未修正
2. **リクエストボディサイズ制限の不足** - 未修正
3. **unwrap()の使用によるパニックリスク** - 詳細を追加

### 中優先度

4. **同時接続数制限の不足** - 未修正
5. **リクエストタイムアウトの不足** - 未修正（ストリーミングへの影響に注意）
6. **パストラバーサル対策の確認不足** - 未修正（データベースパスのみ確認済み）

## 実装優先順位

### Phase 1: 緊急修正（1週間以内）

1. unwrap()の修正（特にRwLockとstrip_prefix）
2. セキュリティヘッダーの追加
3. リクエストボディサイズ制限の追加
4. 入力検証の追加（サイズ制限）

### Phase 2: 短期修正（2週間以内）

5. 同時接続数制限の追加
6. リクエストタイムアウトの追加（ストリーミングは除外）
7. エラーメッセージの一般化（ストリーミング）

### Phase 3: 長期的改善（1ヶ月以内）

8. パストラバーサル対策の確認と修正
9. 競合状態の改善
10. ログ出力の実装

---

**最終更新**: 2025-01-27
**監査者**: Revised Security Audit

