# FLM セキュリティポリシー

## 🔒 セキュリティ方針

**FLMは、すべてのAPI通信をHTTPSで暗号化します。HTTPは使用できません。**

### 理由

1. **パスワード・APIキーの保護**: HTTPではAPIキーやパスワードが平文で送信されるため、中間者攻撃（MITM）で漏洩するリスクがあります
2. **データ改ざん防止**: HTTPSにより通信内容の改ざんを検知できます
3. **プライバシー保護**: ユーザーのリクエスト内容が暗号化されます

---

## ✅ 実装されたセキュリティ機能

### 1. HTTPS必須

- **HTTPモードは完全に無効化**: 証明書がない場合はAPIを起動できません
- **自動証明書生成**: API作成時に自動的に自己署名証明書を生成
- **HTTP→HTTPS自動リダイレクト**: HTTPアクセスは自動的にHTTPSにリダイレクト

### 2. APIキー認証

- **自動生成**: 32文字以上のランダム文字列
- **暗号化保存**: AES-GCMでデータベースに保存
- **SHA256ハッシュ検証**: 平文のAPIキーは保存されません

### 3. セキュリティヘッダー

- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `X-XSS-Protection: 1; mode=block`
- `Referrer-Policy: strict-origin-when-cross-origin`

---

## 🚫 HTTPモードの無効化

### 実装内容

1. **API作成時**: 証明書生成が失敗した場合はAPI作成を拒否
2. **API起動時**: 証明書がない場合は起動を拒否し、エラーメッセージを表示
3. **認証プロキシサーバー**: 証明書がない場合はプロセスを終了（`process.exit(1)`）

### エラーメッセージ

証明書がない場合、以下のメッセージが表示されます：

```
❌ セキュリティエラー: HTTPS証明書が見つかりません。
HTTPは使用できません（パスワード漏洩のリスクがあります）。
証明書を生成してください。
```

---

## ⚠️ 自己署名証明書について

### 現在の実装

- **自己署名証明書を使用**: 正式なCA（認証局）からの証明書ではありません
- **ブラウザ警告**: 初回アクセス時に警告が表示されます（正常です）
- **信頼済み証明書**: 証明書をブラウザ/OSに信頼済みとして追加できます

### 証明書生成の方針

**FLMは、API作成時に自動的に自己署名証明書を生成します。この自動生成された証明書で、APIとして問題なく正常に動作します。**

#### 自動証明書生成の利点

1. **ユーザー操作不要**: 証明書の設定に関する技術的知識が不要
2. **即座に利用可能**: API作成と同時にHTTPS通信が可能になる
3. **APIとして完全に機能**: 自動生成された証明書でAPIとして正常に動作する
4. **ローカルネットワーク対応**: localhostとローカルIPアドレスに対応

#### 証明書に関する重要な方針

- ✅ **自動生成で十分**: 現在の実装では、自動生成された証明書でAPIとして問題なく使用できます
- ✅ **ユーザー証明書アップロード機能は必須ではない**: 将来的な拡張機能として検討されますが、現在の実装でAPIとして正常に機能します
- ⚠️ **ブラウザ警告について**: 自己署名証明書のため、ブラウザで警告が表示されますが、これは正常な動作です。APIとして機能する上で問題はありません

#### 証明書の出所について

- **現在の実装**: アプリケーションが自動生成した自己署名証明書を使用
- **APIとしての動作**: 自動生成された証明書でAPIとして正常に動作します
- **将来の拡張**: ユーザーが自分で発行した証明書（Let's Encrypt、企業CA等）を使用する機能は、将来の拡張として検討されます

### 将来の改善（v1.2以降）

- Let's Encrypt統合
- 正式なSSL証明書の自動取得・更新
- 証明書管理UI
- ユーザー証明書アップロード機能（オプション）

---

## 📝 ユーザーへの案内

### 証明書の警告について

自己署名証明書を使用しているため、ブラウザで警告が表示されます：

1. **Chrome/Edge**: 「この接続ではプライバシーが保護されません」→ 「詳細設定」→ 「続行」をクリック
2. **Firefox**: 「警告: 潜在的なセキュリティリスク」→ 「詳細情報」→ 「リスクを承知で続行」をクリック
3. **Safari**: 「この接続はプライベートではありません」→ 「詳細を表示」→ 「続行」をクリック

**これは正常な動作です。** アプリが生成した証明書は安全です。

### 証明書を信頼済みとして追加（オプション）

証明書の警告を回避するには、証明書をOSに信頼済みとして追加できます：

- **Windows**: 証明書ファイル（`.pem`）をダブルクリック → 「証明書のインストール」→ 「現在のユーザー」→ 「信頼されたルート証明機関」に配置
- **macOS**: 証明書ファイルをキーチェーンアクセスにドラッグ&ドロップ → 「常に信頼」を設定
- **Linux**: 証明書をシステムの信頼済み証明書ストアに追加

---

## 🔍 セキュリティチェックリスト

### API作成時

- ✅ HTTPS証明書が自動生成される
- ✅ 証明書生成が失敗した場合、API作成は拒否される
- ✅ APIキーが自動生成・暗号化保存される

### API起動時

- ✅ 証明書がない場合、起動は拒否される
- ✅ HTTPSサーバーが起動する（ポート: 元のポート+1）
- ✅ HTTPアクセスはHTTPSにリダイレクトされる

### 通信時

- ✅ すべての通信がHTTPSで暗号化される
- ✅ APIキーは`Authorization: Bearer <key>`ヘッダーで送信される
- ✅ セキュリティヘッダーが設定される

---

## 📚 参考資料

- [OWASP - Transport Layer Protection](https://owasp.org/www-community/controls/Cryptographic_Storage_Cheat_Sheet)
- [RFC 8446 - The Transport Layer Security (TLS) Protocol Version 1.3](https://tools.ietf.org/html/rfc8446)

---

**最終更新**: 2024年

