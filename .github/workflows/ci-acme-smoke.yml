name: CI ACME Smoke Test

on:
  schedule:
    # Run nightly
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  acme-test:
    name: ACME Certificate Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        challenge: [http-01, dns-01]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build CLI
        run: cargo build --release -p flm-cli
      - name: Run ACME smoke test
        env:
          ACME_CHALLENGE: ${{ matrix.challenge }}
          ACME_DOMAIN: ${{ secrets.ACME_DOMAIN }}
          ACME_EMAIL: ${{ secrets.ACME_EMAIL }}
          ACME_STAGING: 'true'
        run: |
          chmod +x scripts/ci-acme-smoke.sh
          # スクリプトは--skip-if-no-domainオプションでドメイン未設定時にスキップする
          # ドメインが設定されている場合は実際のテストを実行
          ./scripts/ci-acme-smoke.sh --challenge ${{ matrix.challenge }} --skip-if-no-domain

