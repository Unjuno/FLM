# FLM - システムアーキテクチャ設計書

## 文書情報

- **プロジェクト名**: FLM
- **バージョン**: 1.0.0
- **作成日**: 2024年
- **作成者**: アーキテクトエージェント (ARCH)
- **最終更新日**: 2024年

---

## 目次

1. [技術選定](#技術選定)
2. [システムアーキテクチャ概要](#システムアーキテクチャ概要)
3. [モジュール構成](#モジュール構成)
4. [データフロー](#データフロー)
5. [セキュリティアーキテクチャ](#セキュリティアーキテクチャ)
6. [デプロイメントアーキテクチャ](#デプロイメントアーキテクチャ)

---

## 技術選定

### 最終決定: Tauri

**選定理由**:
- ✅ **軽量**: Electronの約1/10サイズ、起動速度向上
- ✅ **インストーラー自動生成**: Tauri CLIが自動でWindows .exe、macOS .dmg、Linux .AppImageを生成
- ✅ **セキュリティ**: CSP（Content Security Policy）、権限管理が内蔵、デフォルトでセキュア
- ✅ **開発効率**: RustバックエンドでOllama統合が容易、プロセス管理が簡単
- ✅ **クロスプラットフォーム**: Windows、macOS、Linuxの統一ビルド
- ✅ **OSS**: MIT/Apache 2.0ライセンス

**比較検討結果**:

| 項目 | Tauri | Electron |
|------|-------|----------|
| パッケージサイズ | ⭐⭐⭐⭐⭐ (~5MB) | ⭐⭐ (~100MB+) |
| 起動速度 | ⭐⭐⭐⭐⭐ (高速) | ⭐⭐⭐ (やや遅い) |
| メモリ使用量 | ⭐⭐⭐⭐⭐ (低) | ⭐⭐ (高) |
| インストーラー機能 | ⭐⭐⭐⭐⭐ (内蔵) | ⭐⭐⭐ (electron-builder必要) |
| セキュリティ | ⭐⭐⭐⭐⭐ (CSP内蔵) | ⭐⭐⭐ (追加設定必要) |
| Rust統合 | ⭐⭐⭐⭐⭐ (ネイティブ) | ⭐⭐ (FFI必要) |
| コミュニティ | ⭐⭐⭐⭐ (成長中) | ⭐⭐⭐⭐⭐ (成熟) |

**結論**: Tauriを採用する。理由は軽量性、インストーラー自動生成、セキュリティ、Rust統合の容易さ。

---

## システムアーキテクチャ概要

### 全体構成

```
┌─────────────────────────────────────────────────────────────┐
│                    FLM デスクトップアプリ                    │
│                                                               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ フロントエンド (React + TypeScript)                    │ │
│  │ - UI/UX実装                                            │ │
│  │ - IPCクライアント                                      │ │
│  │ - 状態管理 (React State/Context)                       │ │
│  └──────────────┬─────────────────────────────────────────┘ │
│                 │ IPC (Tauri Command Invoke)               │
│  ┌──────────────▼─────────────────────────────────────────┐ │
│  │ バックエンド (Rust + Tauri)                            │ │
│  │ - プロセス管理 (Ollama起動・停止)                       │ │
│  │ - APIキー生成・管理                                    │ │
│  │ - データベース操作 (SQLite)                            │ │
│  │ - ファイルシステム操作                                 │ │
│  └──────────────┬─────────────────────────────────────────┘ │
│                 │ HTTP Proxy                                │
│  ┌──────────────▼─────────────────────────────────────────┐ │
│  │ 認証プロキシ (Express.js + Node.js)                    │ │
│  │ - APIキー検証                                          │ │
│  │ - HTTPプロキシ (express-http-proxy)                    │ │
│  │ - OpenAI互換APIエンドポイント                         │ │
│  └──────────────┬─────────────────────────────────────────┘ │
│                 │ HTTP (localhost:11434)                    │
│  ┌──────────────▼─────────────────────────────────────────┐ │
│  │ Ollama (外部依存)                                      │ │
│  │ - LLM実行エンジン                                       │ │
│  │ - モデル管理                                            │ │
│  │ - OpenAI互換API提供                                     │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ データベース (SQLite)                                  │ │
│  │ - API設定保存                                          │ │
│  │ - APIキー保存（暗号化）                                 │ │
│  │ - モデルカタログ情報キャッシュ                         │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### レイヤー構成

1. **プレゼンテーション層** (フロントエンド)
   - React + TypeScript
   - UI/UX実装
   - ユーザーインタラクション処理

2. **アプリケーション層** (バックエンド)
   - Rust + Tauri
   - ビジネスロジック
   - プロセス管理
   - データアクセス制御

3. **インフラストラクチャ層**
   - SQLite (データベース)
   - Express.js (認証プロキシ)
   - Ollama (外部依存)

---

## モジュール構成

### 1. フロントエンドモジュール (`src/`)

```
src/
├── components/          # UIコンポーネント
│   ├── api/
│   │   ├── ApiCreateForm.tsx
│   │   ├── ApiList.tsx
│   │   └── ApiTest.tsx
│   ├── model/
│   │   ├── ModelCatalog.tsx
│   │   └── ModelDownload.tsx
│   └── common/
│       ├── Loading.tsx
│       └── ErrorMessage.tsx
├── pages/               # ページコンポーネント
│   ├── Home.tsx
│   ├── ApiCreate.tsx
│   ├── ApiList.tsx
│   └── ModelManagement.tsx
├── hooks/               # カスタムフック
│   ├── useIpc.ts        # IPC呼び出し
│   ├── useApi.ts        # API関連
│   └── useModel.ts      # モデル関連
├── stores/              # 状態管理
│   └── apiStore.ts
├── utils/               # ユーティリティ
│   └── apiClient.ts
└── App.tsx
```

### 2. バックエンドモジュール (`src-tauri/src/`)

```
src-tauri/src/
├── main.rs              # エントリーポイント
├── commands.rs          # Tauriコマンド定義
├── ollama.rs           # Ollama統合モジュール
│   ├── detection.rs    # Ollama検出
│   ├── download.rs     # Ollamaダウンロード
│   └── process.rs      # プロセス管理
├── database/            # データベースモジュール
│   ├── mod.rs
│   ├── schema.rs       # スキーマ定義
│   ├── repository.rs   # データアクセス層
│   └── migrations.rs   # マイグレーション
├── auth/                # 認証モジュール
│   ├── mod.rs
│   └── keygen.rs       # APIキー生成
└── utils/               # ユーティリティ
    └── error.rs         # エラーハンドリング
```

### 3. 認証プロキシモジュール (`src/backend/auth/`)

```
src/backend/auth/
├── proxy.ts            # HTTPプロキシ実装
├── keygen.ts          # APIキー生成
├── validator.ts       # APIキー検証
└── server.ts          # Express.jsサーバー
```

---

## データフロー

### 1. API作成フロー

```
ユーザー操作 (UI)
  ↓
React Component (ApiCreateForm)
  ↓ invoke('create_api', ...)
Tauri Command (commands::create_api)
  ↓
1. Ollama検出・起動 (ollama::process::start)
2. APIキー生成 (auth::keygen::generate)
3. データベース保存 (database::repository::save_api)
4. 認証プロキシ起動 (Node.jsプロセス起動)
  ↓
成功レスポンス
  ↓
UI表示 (API情報)
```

### 2. API利用フロー（チャット）

```
ユーザー入力 (UI)
  ↓
React Component (ApiTest)
  ↓ fetch()
HTTP POST http://localhost:8080/v1/chat/completions
  Authorization: Bearer <API_KEY>
  ↓
認証プロキシ (Express.js)
  ↓ APIキー検証
Ollama API POST http://localhost:11434/api/chat
  ↓
Ollama処理
  ↓
レスポンス返却
  ↓
UI表示
```

### 3. モデルダウンロードフロー

```
ユーザー操作 (UI)
  ↓
React Component (ModelDownload)
  ↓ invoke('download_model', ...)
Tauri Command (commands::download_model)
  ↓
Ollama API POST http://localhost:11434/api/pull
  ↓ ストリーミング
進捗更新 (IPC Event)
  ↓
UI更新 (プログレスバー)
```

---

## セキュリティアーキテクチャ

### 1. APIキー管理

- **生成**: 32文字以上のランダム文字列（crypto使用）
- **保存**: SQLiteに暗号化して保存（AES-256-GCM）
- **検証**: 認証プロキシでBearer Tokenとして検証

### 2. IPC通信セキュリティ

- **Tauri CSP**: デフォルトのCSP設定を使用
- **コマンド許可**: `tauri.conf.json`で許可されたコマンドのみ実行可能
- **データ検証**: Rust側で全ての入力データを検証

### 3. プロキシセキュリティ

- **ネットワークアクセス**: 認証プロキシはデフォルトで `0.0.0.0` にバインドされ、外部からのアクセスも可能です
- **APIキー必須**: 全てのリクエストでAPIキー検証（Bearer Token認証）
- **CORS対応**: クロスオリジンリクエストをサポート
- **外部アクセス時の注意**: 
  - 外部からアクセス可能にする場合は、適切なファイアウォール設定とセキュリティ対策が必要です
  - 本番環境ではHTTPSの使用を推奨（将来実装予定）
  - IPホワイトリスト機能は将来実装予定（v1.3以降）
  - レート制限機能は将来実装予定（v1.3以降）

---

## デプロイメントアーキテクチャ

### 1. ビルドプロセス

```
1. フロントエンドビルド
   npm run build
   → dist/ にビルド成果物

2. Rustバックエンドビルド
   cargo build --release
   → target/release/flm.exe (Windows)

3. Tauriバンドル
   npm run tauri build
   → src-tauri/target/release/bundle/
   → .exe インストーラー生成
```

### 2. パッケージング

- **Windows**: `.exe` インストーラー (NSIS)
- **macOS**: `.dmg` (将来実装)
- **Linux**: `.AppImage` (将来実装)

### 3. 依存関係

- **必須**: ユーザーがOllamaをインストール（または自動インストール）
- **オプション**: Node.js（認証プロキシ実行用、Tauriバンドルに含める）

---

## モジュール間インターフェース

詳細は `INTERFACE_SPEC.md` を参照。

---

## データベース設計

詳細は `DATABASE_SCHEMA.sql` を参照。

---

## 実装完了機能（v1.0）

### フェーズ2: 基盤機能
- ✅ **F009: Ollama自動インストール機能**
  - システムパス検出、ポータブル版検出
  - GitHub Releases APIからの自動ダウンロード
  - プロセス管理（起動・停止）

### フェーズ3: コア機能
- ✅ **F001: API作成機能**
  - API設定の作成・保存
  - APIキー生成・暗号化保存
  - Ollama起動確認・自動起動
  - 認証プロキシ自動起動

- ✅ **F002: API利用機能**
  - OpenAI互換APIエンドポイント（`/v1/chat/completions`, `/v1/models`）
  - チャットインターフェース実装
  - リアルタイムレスポンス表示

- ✅ **F003: API管理機能**
  - API一覧表示・管理
  - API起動・停止
  - 設定変更（ポート、認証設定）
  - API削除（関連リソース自動削除）
  - APIキー再生成

- ✅ **F004: モデル管理機能**
  - モデルカタログ表示（検索・フィルタ）
  - モデルダウンロード（進捗表示）
  - インストール済みモデル管理
  - モデル削除

- ✅ **F005: 認証機能**
  - APIキー生成・暗号化保存（AES-256-GCM）
  - 認証プロキシ実装（Express.js）
  - Bearer Token認証
  - APIキー検証・管理

### フェーズ4: 基盤機能
- ✅ **F006: リクエストログ機能（基盤）**
  - リクエストログテーブル設計
  - ログ記録ミドルウェア実装
  - ログ保存・取得IPCコマンド

---

## 将来の拡張計画

### v1.1（次期リリース予定）
- **F006: ログ表示機能（完全版）**
  - フロントエンドでのログ表示UI
  - ログ検索・フィルタ機能
  - ログエクスポート機能

- **F007: パフォーマンス監視機能**
  - レスポンス時間監視
  - リクエスト数統計
  - エラー率監視

### v1.3（計画中）
- **複数LLM実行エンジン対応（Phase 1）**
  - 抽象化レイヤー（`LlmEngine` Trait）の実装
  - LM Studioエンジン対応
  - エンジン選択UIの実装
  - データベーススキーマの拡張

### v2.0（将来的な拡張）
- **macOS/Linux対応の完全実装**
  - クロスプラットフォームビルド設定
  - プラットフォーム固有機能の実装

- **複数API同時実行対応**
  - 複数ポートでの同時起動
  - リソース管理の最適化

- **複数LLM実行エンジン対応（Phase 2）**
  - vLLM、llama.cpp、text-generation-webui対応
  - カスタムエンドポイント対応

### v2.1以降
- **クラウド同期機能（オプション）**
  - 設定のクラウド同期
  - モデルカタログのクラウド更新

---

**最終更新日**: 2024年（フェーズ4完了時点）

