# 環境変数ドキュメント

このドキュメントでは、FLMアプリケーションで使用される環境変数の一覧と説明を提供します。

## 概要

環境変数は、アプリケーションの動作を制御するために使用されます。機密情報を含む環境変数については、適切に保護する必要があります。

---

## 環境変数一覧

### 認証プロキシサーバー関連

#### `PORT`
- **説明**: 認証プロキシサーバーがリッスンするポート番号
- **型**: 数値
- **デフォルト値**: `8080`
- **有効範囲**: `1024` - `65535`
- **機密情報**: いいえ
- **必須**: いいえ
- **例**: `PORT=8080`

#### `NODE_ENV`
- **説明**: 実行環境を指定します。開発環境、本番環境、テスト環境を区別します
- **型**: 文字列
- **デフォルト値**: `production`
- **許可値**: `development`, `production`, `test`
- **機密情報**: いいえ
- **必須**: いいえ
- **例**: `NODE_ENV=production`
- **注意**: 本番環境では必ず `production` に設定してください

#### `OLLAMA_URL`
- **説明**: Ollama APIのベースURL
- **型**: 文字列（URL形式）
- **デフォルト値**: `http://localhost:11434`
- **機密情報**: いいえ
- **必須**: いいえ
- **例**: `OLLAMA_URL=http://localhost:11434`

#### `API_ID`
- **説明**: 認証プロキシサーバーで使用されるAPI ID（環境変数から取得）
- **型**: 文字列
- **デフォルト値**: なし（空文字列）
- **機密情報**: いいえ（IDのみ）
- **必須**: いいえ
- **例**: `API_ID=api-12345`

#### `ENGINE_BASE_URL`
- **説明**: エンジンのベースURL（Ollama以外のエンジンを使用する場合）
- **型**: 文字列（URL形式）
- **デフォルト値**: なし（`OLLAMA_URL`が使用される）
- **機密情報**: いいえ
- **必須**: いいえ
- **例**: `ENGINE_BASE_URL=http://localhost:11434`

#### `ENGINE_TYPE`
- **説明**: 使用するエンジンのタイプ
- **型**: 文字列
- **デフォルト値**: `ollama`
- **機密情報**: いいえ
- **必須**: いいえ
- **例**: `ENGINE_TYPE=ollama`

#### `ALLOWED_ORIGINS`
- **説明**: CORSで許可するオリジンのリスト（カンマ区切り）
- **型**: 文字列（カンマ区切り）
- **デフォルト値**: なし（すべてのオリジンを許可）
- **機密情報**: いいえ
- **必須**: いいえ
- **例**: `ALLOWED_ORIGINS=http://localhost:3000,https://example.com`
- **注意**: 本番環境では適切なオリジンを設定してください

#### `FLM_DATA_DIR`
- **説明**: FLMアプリケーションのデータディレクトリのパス
- **型**: 文字列（ファイルパス）
- **デフォルト値**: なし（システムのデフォルトディレクトリを使用）
- **機密情報**: いいえ（ファイルパスのみ）
- **必須**: いいえ
- **例**: `FLM_DATA_DIR=C:\Users\username\AppData\Local\FLM`

### レート制限関連

#### `RATE_LIMIT_ENABLED`
- **説明**: レート制限機能の有効/無効を制御します
- **型**: 真偽値
- **デフォルト値**: `true`
- **許可値**: `true`, `false`, `1`, `0`, `yes`, `no`
- **機密情報**: いいえ
- **必須**: いいえ
- **例**: `RATE_LIMIT_ENABLED=true`

#### `RATE_LIMIT_REQUESTS`
- **説明**: レート制限の時間窓内で許可される最大リクエスト数
- **型**: 数値
- **デフォルト値**: `100`
- **有効範囲**: `1` - `10000`
- **機密情報**: いいえ
- **必須**: いいえ
- **例**: `RATE_LIMIT_REQUESTS=100`

#### `RATE_LIMIT_WINDOW_SECONDS`
- **説明**: レート制限の時間窓（秒単位）
- **型**: 数値
- **デフォルト値**: `60`
- **有効範囲**: `1` - `3600`
- **機密情報**: いいえ
- **必須**: いいえ
- **例**: `RATE_LIMIT_WINDOW_SECONDS=60`

---

## 機密情報を含む環境変数

現在の実装では、環境変数に直接機密情報（APIキー、パスワードなど）を保存することは推奨されていません。機密情報は以下の方法で管理されます：

1. **APIキー**: データベースに暗号化して保存
2. **認証トークン**: データベースに暗号化して保存
3. **データベースパス**: アプリケーションの設定ファイルに保存（必要に応じてマスク処理）

### 注意事項

- 環境変数に機密情報を設定する場合は、以下の点に注意してください：
  - 環境変数はプロセス間で共有される可能性があります
  - ログに出力される可能性があります（現在の実装ではマスク処理を実装）
  - システムの環境変数一覧から読み取られる可能性があります

---

## 環境変数の設定方法

### Windows

```powershell
# 一時的な設定（現在のセッションのみ）
$env:PORT = "8080"
$env:NODE_ENV = "production"

# 永続的な設定（システム環境変数）
[System.Environment]::SetEnvironmentVariable("PORT", "8080", "Machine")
```

### macOS / Linux

```bash
# 一時的な設定（現在のセッションのみ）
export PORT=8080
export NODE_ENV=production

# 永続的な設定（~/.bashrc または ~/.zshrc に追加）
echo 'export PORT=8080' >> ~/.bashrc
echo 'export NODE_ENV=production' >> ~/.bashrc
source ~/.bashrc
```

### .env ファイル（開発環境）

開発環境では、プロジェクトルートに `.env` ファイルを作成して環境変数を設定できます：

```env
PORT=8080
NODE_ENV=development
OLLAMA_URL=http://localhost:11434
RATE_LIMIT_ENABLED=true
RATE_LIMIT_REQUESTS=100
RATE_LIMIT_WINDOW_SECONDS=60
```

**注意**: `.env` ファイルは `.gitignore` に追加して、バージョン管理に含めないでください。

---

## 環境変数の検証

アプリケーション起動時に、環境変数の型と範囲が自動的に検証されます。

### 検証内容

- **型検証**: 文字列、数値、真偽値の型チェック
- **範囲検証**: 数値の最小値・最大値チェック
- **許可値検証**: 文字列の許可値リストチェック

### 検証エラーの動作

- **本番環境**: 検証エラーが発生した場合、アプリケーションは起動しません
- **開発環境**: 検証エラーが発生した場合、警告を出力して処理を続行します

---

## トラブルシューティング

### 環境変数が読み込まれない

1. 環境変数が正しく設定されているか確認してください
2. アプリケーションを再起動してください
3. 環境変数の名前が正しいか確認してください（大文字・小文字を区別）

### 検証エラーが発生する

1. 環境変数の値が正しい型か確認してください
2. 数値の場合は、有効範囲内か確認してください
3. 文字列の場合は、許可された値か確認してください

### デフォルト値を使用したい

環境変数を設定しない場合、デフォルト値が使用されます。デフォルト値の一覧は、各環境変数の説明を参照してください。

---

## 関連ドキュメント

- [開発環境セットアップガイド](./DEVELOPMENT_SETUP.md)
- [トラブルシューティングガイド](./TROUBLESHOOTING.md)
- [セキュリティ監査レポート](./reports/SECURITY_AUDIT_REPORT_FINAL.md)

---

**最終更新**: 2025年1月

