# FLM アプリケーション情報

## 📱 アプリケーションの種類

**FLMはTauriフレームワークで構築されたデスクトップアプリケーションです。**

- **フロントエンド**: React + TypeScript（Web技術）
- **バックエンド**: Rust（Tauriフレームワーク）
- **プラットフォーム**: Windows, macOS, Linux対応

Tauriアプリケーションは、Web技術（HTML/CSS/JavaScript）でUIを構築し、Rustでデスクトップアプリケーションとして動作します。

---

## 🔒 APIの外部公開とセキュリティについて

### 現在の実装状況

#### ✅ 実装済みのセキュリティ機能

1. **認証機能（オプション）**
   - APIキーベースの認証システム
   - APIキーは32文字以上のランダム文字列
   - 暗号化されてデータベースに保存
   - SHA256ハッシュによる検証

2. **認証プロキシ**
   - 認証を有効にした場合、認証プロキシサーバーが起動
   - リクエストの認証チェックを実施

3. **データベース暗号化**
   - APIキーはAES-GCMで暗号化
   - データベースファイル自体は暗号化されていない（注意）

#### ✅ 外部公開対応

**FLMはデフォルトで外部（ローカルネットワーク）からのアクセスに対応しています！**

1. **すべてのネットワークインターフェースでリッスン**
   - 認証プロキシサーバーは`0.0.0.0`でリッスン
   - 同一LAN内のデバイスからアクセス可能
   - エンドポイントには`localhost`とローカルIPアドレスの両方が表示されます

2. **エンドポイントURL**
   - ローカルアクセス: `http://localhost:{port}`
   - ローカルネットワーク: `http://{your-ip}:{port}` (例: `http://192.168.1.100:8080`)
   - アプリ内で両方のURLが自動的に表示されます

#### ✅ HTTPS対応（実装済み）

**FLMはHTTPS対応を実装しています！**

1. **自動HTTPS証明書生成**
   - API作成時に自動的に自己署名証明書を生成
   - 証明書はアプリケーションデータディレクトリに保存
   - ローカルIPとlocalhostに対応
   - **重要な方針**: 自動生成された証明書で、APIとして問題なく正常に動作します

2. **HTTPSサーバー自動起動**
   - 証明書が存在する場合、HTTPSサーバーが自動起動
   - HTTPSポート: 元のポート+1 (例: 8080→8081)
   - HTTPアクセスは自動的にHTTPSにリダイレクト

3. **エンドポイントURL**
   - HTTPSアクセス: `https://localhost:{port+1}` または `https://{your-ip}:{port+1}`
   - HTTP→HTTPS自動リダイレクト: `http://localhost:{port}` → `https://localhost:{port+1}`

4. **証明書に関する方針**
   - **自動生成で十分**: 現在の実装では、自動生成された証明書でAPIとして問題なく使用できます
   - **ユーザー証明書アップロード機能**: 将来的な拡張機能として検討されますが、必須ではありません
   - **APIとしての動作**: 自動生成された証明書でAPIとして完全に機能します

5. **追加のセキュリティ対策が必要**
   - レート制限（実装されていない）
   - 入力検証の強化
   - CORS設定
   - ファイアウォール設定
   - DDoS対策

---

## 🌐 インターネットに公開する場合の手順

### ✅ **ローカルネットワーク（同一LAN内）からのアクセス**

**デフォルトで既に対応済みです！**

- 同一Wi-Fi/LANに接続されている他のデバイスからアクセス可能
- エンドポイントURLにローカルIPアドレスが自動表示されます
- 例: `http://192.168.1.100:8080`

### ✅ **インターネット経由で公開する場合**

**FLMは既にHTTPS対応済みです！自己署名証明書を使用しているため、以下の点に注意してください：**

1. **自己署名証明書について**
   - アプリは自動的に自己署名証明書を生成します
   - ブラウザで警告が表示されますが、これは正常です
   - 本番環境では、Let's Encryptなどの正式な証明書の使用を推奨します（将来の機能）

2. **現在のセキュリティ機能**
   - ✅ HTTPS暗号化通信
   - ✅ APIキーベース認証
   - ✅ リクエストログ記録
   - ⚠️ レート制限（将来の機能）

### 必要な作業

1. **ネットワーク設定**
   ```bash
   # ルーターでポートフォワーディングを設定
   # 例: 外部ポート8080 → 内部IP:ポート8080
   ```

2. **ファイアウォール設定**
   ```powershell
   # Windowsファイアウォールでポートを開放（注意深く設定）
   New-NetFirewallRule -DisplayName "FLM API" -Direction Inbound -LocalPort 8080 -Protocol TCP -Action Allow
   ```

3. **HTTPSの設定（必須）**
   - リバースプロキシ（Nginx、Caddy等）を使用
   - Let's EncryptでSSL証明書を取得
   - HTTPS経由でのみアクセス許可

4. **セキュリティ強化**
   - 必ず認証を有効化（`enable_auth: true`）
   - 強力なAPIキーを使用
   - アクセスログの監視
   - 定期的なセキュリティ監査

5. **推奨構成**
   ```
   インターネット
        ↓
   [リバースプロキシ（HTTPS）]
        ↓
   [ファイアウォール]
        ↓
   [FLM API（HTTP localhost）]
   ```

---

## 🛡️ セキュリティベストプラクティス

### ローカル使用の場合

- ✅ 認証を有効化（推奨）
- ✅ 強力なAPIキーを使用
- ✅ 不要な場合はAPIを停止

### インターネット公開の場合

- ✅ **必ずHTTPSを使用**
- ✅ **リバースプロキシを経由**
- ✅ **認証を必須にする**
- ✅ **レート制限を実装（将来の機能）**
- ✅ **アクセスログを監視**
- ✅ **定期的にセキュリティ更新**
- ✅ **最小限のポートのみ開放**
- ✅ **不要な機能は無効化**

---

## 📝 現在のエラーについて

### `Cannot read properties of undefined (reading 'invoke')`

このエラーは、Tauriバックエンドが正しく初期化されていない場合に発生します。

**対処法**:
1. すべてのNode/Tauriプロセスを終了
   ```powershell
   .\fix-port-1420.ps1
   ```
2. Tauriアプリを再起動
   ```bash
   npm run tauri:dev
   ```
3. アプリのウィンドウが完全に表示されるまで待つ

**改善済み**: `ThemeContext.tsx`でTauri環境のチェックを追加し、より分かりやすいエラーメッセージを表示するようにしました。

---

## 🎨 UI/UXの改善について

ご指摘の通り、現在のUIは技術的なエラーメッセージをそのまま表示しています。

**改善予定**:
- ✅ エラーメッセージをユーザーフレンドリーに（一部実装済み）
- ⏳ エラーの自動リトライ機能
- ⏳ より分かりやすい説明とヘルプ
- ⏳ 初回起動時のガイド

---

## 📚 関連ドキュメント

- [QUICK_TEST_GUIDE.md](./QUICK_TEST_GUIDE.md) - テスト実行ガイド
- [DOCKS/SPECIFICATION.md](./DOCKS/SPECIFICATION.md) - 完全な仕様書
- [DOCKS/ARCHITECTURE.md](./DOCKS/ARCHITECTURE.md) - アーキテクチャ設計書

---

**最終更新**: 2024年

